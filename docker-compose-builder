DOCKER_COMPOSE_FILE="./docker-compose-dev.yaml"
CLIENTS=1

while [ $# -gt 0 ]; do
  case "$1" in
    --file=*)
      DOCKER_COMPOSE_FILE="${1#*=}"
      ;;
    --clients=*)
      CLIENTS="${1#*=}"
      ;;
  esac
  shift
done

createDockerComposeFile() {
	if [ -f $DOCKER_COMPOSE_FILE ]; then
		rm $DOCKER_COMPOSE_FILE
	fi;
	touch $DOCKER_COMPOSE_FILE
}

setVersion() {
	echo "version: '${1}'" 								>> $DOCKER_COMPOSE_FILE
}

setServices() {
	echo ""												>> $DOCKER_COMPOSE_FILE
	echo "services:"									>> $DOCKER_COMPOSE_FILE

	setServer
	setClients
}

setServer() {
	echo "  server:"									>> $DOCKER_COMPOSE_FILE
	echo "    container_name: server"					>> $DOCKER_COMPOSE_FILE
    echo "    image: server:latest"						>> $DOCKER_COMPOSE_FILE
    echo "    entrypoint: python3 /main.py"				>> $DOCKER_COMPOSE_FILE
    echo "    environment:"								>> $DOCKER_COMPOSE_FILE
    echo "      - PYTHONUNBUFFERED=1"					>> $DOCKER_COMPOSE_FILE
    echo "      - SERVER_IP=server"						>> $DOCKER_COMPOSE_FILE
    echo "      - SERVER_PORT=12345"					>> $DOCKER_COMPOSE_FILE
    echo "      - SERVER_LISTEN_BACKLOG=5"				>> $DOCKER_COMPOSE_FILE
    echo "    networks:"								>> $DOCKER_COMPOSE_FILE
    echo "      - testing_net"							>> $DOCKER_COMPOSE_FILE
}

setClients() {
	for i in $(seq 1 $CLIENTS)
	do
		echo ""											>> $DOCKER_COMPOSE_FILE
		echo "  client$i:"								>> $DOCKER_COMPOSE_FILE
    	echo "    container_name: client$i"				>> $DOCKER_COMPOSE_FILE
    	echo "    image: client:latest"					>> $DOCKER_COMPOSE_FILE
    	echo "    entrypoint: /client"					>> $DOCKER_COMPOSE_FILE
    	echo "    environment:"							>> $DOCKER_COMPOSE_FILE
      	echo "      - CLI_ID=$i"						>> $DOCKER_COMPOSE_FILE
      	echo "      - CLI_SERVER_ADDRESS=server:12345"	>> $DOCKER_COMPOSE_FILE
      	echo "      - CLI_LOOP_LAPSE=1m2s"				>> $DOCKER_COMPOSE_FILE
      	echo "      - CLI_LOOP_PERIOD=10s"				>> $DOCKER_COMPOSE_FILE
    	echo "    networks:"							>> $DOCKER_COMPOSE_FILE
      	echo "      - testing_net"						>> $DOCKER_COMPOSE_FILE
    	echo "    depends_on:"							>> $DOCKER_COMPOSE_FILE
      	echo "      - server"							>> $DOCKER_COMPOSE_FILE
	done
}

setNetwork() {
	echo ""												>> $DOCKER_COMPOSE_FILE
	echo "networks:" 									>> $DOCKER_COMPOSE_FILE
	echo "  testing_net:" 								>> $DOCKER_COMPOSE_FILE
	echo "    ipam:" 									>> $DOCKER_COMPOSE_FILE
	echo "      driver: default" 						>> $DOCKER_COMPOSE_FILE
	echo "        config:" 								>> $DOCKER_COMPOSE_FILE
	echo "          - subnet: ${1}" 					>> $DOCKER_COMPOSE_FILE
}

createDockerComposeFile
setVersion "3"
setServices
setNetwork "172.25.125.0/24"